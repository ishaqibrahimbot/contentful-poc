name: Contentful Apply Migration

on:
  pull_request:
    types: [closed]

jobs:
  contentful-apply-migration:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Contentful CLI
        run: npm install -g contentful-cli

      - name: Get PR base and head refs
        id: pr-refs
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"

          # If PR base is main, use master for base
          if [ "$BASE_REF" = "main" ]; then
            BASE_REF="master"
          fi

          # Replace "/" with "-" in branch names
          BASE_REF_CLEAN=$(echo "$BASE_REF" | sed 's/\//-/g')
          HEAD_REF_CLEAN=$(echo "$HEAD_REF" | sed 's/\//-/g')

          echo "base_ref=$BASE_REF_CLEAN" >> $GITHUB_OUTPUT
          echo "head_ref=$HEAD_REF_CLEAN" >> $GITHUB_OUTPUT

      - name: Export migration script
        id: export-migration
        run: |
          # Create migrations directory if it doesn't exist
          mkdir -p migrations

          # Generate migration filename with timestamp
          MIGRATION_FILE="migrations/migration-$(date +%Y%m%d-%H%M%S).js"

          # Export migration script
          contentful merge export \
            --te ${{ steps.pr-refs.outputs.base_ref }} \
            --se ${{ steps.pr-refs.outputs.head_ref }} \
            --space-id ${{ secrets.CONTENTFUL_SPACE_ID }} \
            --management-token ${{ secrets.CONTENTFUL_MANAGEMENT_TOKEN }} \
            --output-file $MIGRATION_FILE \
            -y

          echo "migration_file=$MIGRATION_FILE" >> $GITHUB_OUTPUT

      - name: Apply migration
        id: apply-migration
        run: |
          # Apply the migration to the base environment
          OUTPUT=$(contentful space migration \
            --space-id ${{ secrets.CONTENTFUL_SPACE_ID }} \
            --management-token ${{ secrets.CONTENTFUL_MANAGEMENT_TOKEN }} \
            --environment-id ${{ steps.pr-refs.outputs.base_ref }} \
            ${{ steps.export-migration.outputs.migration_file }} \
            -y \
            2>&1 || echo "Migration failed with exit code $?")

          echo "$OUTPUT" > migration_output.txt

          # Create multiline output for GitHub Actions
          echo "migration_output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Clean up temporary environment
        if: success()
        run: |
          # Delete the temporary head environment after successful migration
          contentful space environment delete \
            --environment-id ${{ steps.pr-refs.outputs.head_ref }} \
            --space-id ${{ secrets.CONTENTFUL_SPACE_ID }} \
            --management-token ${{ secrets.CONTENTFUL_MANAGEMENT_TOKEN }}

      - name: Comment PR with migration results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read the migration output from the file
            let output;
            try {
              output = fs.readFileSync('migration_output.txt', 'utf8');
            } catch (error) {
              output = 'Failed to read migration output';
            }

            // Create the comment body
            const commentBody = `## ðŸš€ Contentful Migration Applied

            Migration has been applied from head branch (\`${{ steps.pr-refs.outputs.head_ref }}\`) to base environment (\`${{ steps.pr-refs.outputs.base_ref }}\`).

            **Migration File:** \`${{ steps.export-migration.outputs.migration_file }}\`

            <details>
            <summary>ðŸ“‹ Migration Results</summary>

            \`\`\`
            ${output}
            \`\`\`

            </details>

            ---
            *This comment was automatically generated by the Contentful Apply Migration workflow.*`;

            // Post the comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
