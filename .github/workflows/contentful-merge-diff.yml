name: Contentful Merge Diff

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  contentful-merge-diff:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Contentful CLI
        run: npm install -g contentful-cli

      - name: Get PR base and head refs
        id: pr-refs
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"

          # If PR head is main, use master for base
          if [ "$HEAD_REF" = "main" ]; then
            BASE_REF="master"
          fi

          # Replace "/" with "-" in branch names
          BASE_REF_CLEAN=$(echo "$BASE_REF" | sed 's/\//-/g')
          HEAD_REF_CLEAN=$(echo "$HEAD_REF" | sed 's/\//-/g')

          echo "base_ref=$BASE_REF_CLEAN" >> $GITHUB_OUTPUT
          echo "head_ref=$HEAD_REF_CLEAN" >> $GITHUB_OUTPUT

      - name: Run Contentful merge diff
        id: merge-diff
        run: |
          # Run the contentful merge show command and capture output
          OUTPUT=$(contentful merge show \
            --se ${{ steps.pr-refs.outputs.base_ref }} \
            --te ${{ steps.pr-refs.outputs.head_ref }} \
            --space-id ${{ secrets.CONTENTFUL_SPACE_ID }} \
            --management-token ${{ secrets.CONTENTFUL_MANAGEMENT_TOKEN }} \
            -y \
            2>&1 || echo "Command failed with exit code $?")

          # Save output to a file and environment variable for the comment step
          echo "$OUTPUT" > merge_diff_output.txt

          # Create multiline output for GitHub Actions
          echo "merge_output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR with merge diff
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read the output from the file
            let output;
            try {
              output = fs.readFileSync('merge_diff_output.txt', 'utf8');
            } catch (error) {
              output = 'Failed to read contentful merge diff output';
            }

            // Create the comment body
            const commentBody = `## ðŸ”„ Contentful Merge Diff

            This shows the differences between the base branch (\`${{ steps.pr-refs.outputs.base_ref }}\`) and head branch (\`${{ steps.pr-refs.outputs.head_ref }}\`) in your Contentful space.

            <details>
            <summary>ðŸ“‹ Contentful Changes</summary>

            \`\`\`
            ${output}
            \`\`\`

            </details>

            ---
            *This comment was automatically generated by the Contentful Merge Diff workflow.*`;

            // Post the comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
